<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bầu chọn ngày đá banh</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .container { 
      max-width: 480px; 
      margin: 40px auto; 
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    
    .header h2 { 
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .week-info { 
      font-size: 14px;
      opacity: 0.9;
    }
    
    .content {
      padding: 32px 24px;
    }
    
    .period-selector {
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .period-selector label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #64748b;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .period-selector label:hover {
      color: #475569;
    }
    
    .period-selector input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: #667eea;
    }
    
    .vote-form {
      background: #f8fafc;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 32px;
      border: 1px solid #e2e8f0;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    input[type="text"], select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: white;
    }
    
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .submit-btn {
      width: 100%;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .submit-btn:hover {
      background: #5a67d8;
    }
    
    .submit-btn:active {
      transform: translateY(1px);
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
      text-align: center;
      background: #e0f2fe;
      color: #0277bd;
      border: 1px solid #b3e5fc;
    }
    
    .results-section h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1e293b;
    }
    
    .summary {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .summary b {
      color: #059669;
    }
    
    .votes-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .votes-table th {
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .votes-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    
    .votes-table tr:hover {
      background: #f8fafc;
    }
    
    .votes-table tr:last-child td {
      border-bottom: none;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
      font-style: italic;
    }
    
    @media (max-width: 520px) {
      .container {
        margin: 20px;
        border-radius: 12px;
      }
      
      .header {
        padding: 24px 20px;
      }
      
      .content {
        padding: 24px 20px;
      }
      
      .period-selector {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Bầu chọn ngày đá banh only 19h30</h2>
      <div class="week-info" id="weekInfo"></div>
    </div>
    
    <div class="content">
      <!-- Chọn đợt vote -->
      <div class="period-selector">
        <label><input type="radio" name="period" value="dau-tuan" checked> Đầu tuần (T2-T3-T4)</label>
        <label><input type="radio" name="period" value="cuoi-tuan"> Cuối tuần (T6-T7-CN)</label>
      </div>
      
      <form class="vote-form" id="voteForm">
        <div class="form-group">
          <input type="text" id="name" placeholder="Nhập tên của bạn" required>
        </div>
        <div class="form-group">
          <select id="choice" required></select>
        </div>
        <div class="form-group">
          <button type="submit" class="submit-btn">Gửi vote</button>
        </div>
      </form>
      
      <div class="message" id="msg" style="display: none;"></div>
      
      <div class="results-section">
        <h3>Kết quả vote (<span id="periodLabel">Đầu tuần</span>)</h3>
        <div class="summary" id="summary"></div>
        <table class="votes-table" id="voteTable">
          <thead>
            <tr>
              <th>Tên</th>
              <th>Ngày vote</th>
              <th>Lựa chọn</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <script>
    // Hàm lấy số tuần hiện tại
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    const now = new Date();
    const week = getWeekNumber(now);
    document.getElementById('weekInfo').innerText = 
      "Tuần " + week + " (" + now.toLocaleDateString('vi-VN') + ")";
    
    // ====== Firebase config ======
    const firebaseConfig = {
      apiKey: "AIzaSyCIZEY6HPUSr9TrFNd5ll6CW4Rb5nXWRYU",
      authDomain: "football-vote-b352a.firebaseapp.com",
      databaseURL: "https://football-vote-b352a-default-rtdb.firebaseio.com",
      projectId: "football-vote-b352a",
      storageBucket: "football-vote-b352a.appspot.com",
      messagingSenderId: "30415817820",
      appId: "1:30415817820:web:bb14f6004948d214b62a99",
      measurementId: "G-70HX6VLXV6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ========== Chọn đợt vote và render form ==========
    const periodOptions = {
      "dau-tuan": ["Thứ 2", "Thứ 3", "Thứ 4"],
      "cuoi-tuan": ["Thứ 6", "Thứ 7", "Chủ Nhật"]
    };
    const periodLabels = {
      "dau-tuan": "Đầu tuần",
      "cuoi-tuan": "Cuối tuần"
    };
    let currentPeriod = "dau-tuan";
    const periodRadios = document.querySelectorAll('input[name="period"]');
    const choiceSelect = document.getElementById("choice");
    const periodLabel = document.getElementById("periodLabel");
    const summary = document.getElementById("summary");
    const msgElement = document.getElementById("msg");

    // Hàm render các ngày cho từng đợt vote
    function renderChoiceOptions(period) {
      choiceSelect.innerHTML = '<option value="">-- Chọn ngày --</option>';
      periodOptions[period].forEach(day => {
        const opt = document.createElement("option");
        opt.value = day;
        opt.textContent = day;
        choiceSelect.appendChild(opt);
      });
    }

    // Lắng nghe thay đổi đợt vote
    periodRadios.forEach(radio => {
      radio.addEventListener("change", e => {
        currentPeriod = e.target.value;
        periodLabel.textContent = periodLabels[currentPeriod];
        renderChoiceOptions(currentPeriod);
        loadVotes();
      });
    });

    // Init mặc định
    renderChoiceOptions(currentPeriod);

    // ========== Load votes cho đợt hiện tại và tổng hợp ==========
    function loadVotes() {
      db.ref(`votes/${week}/${currentPeriod}`).on("value", (snapshot) => {
        const tbody = document.querySelector('#voteTable tbody');
        tbody.innerHTML = '';
        const data = snapshot.val();
        const countByDay = {};
        
        if (data) {
          // Hiển thị mới nhất lên đầu
          const rows = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
          rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${row.name}</td><td>${row.date}</td><td>${row.choice}</td>`;
            tbody.appendChild(tr);
            // Tổng hợp
            countByDay[row.choice] = (countByDay[row.choice] || 0) + 1;
          });
        }
        
        // Thống kê tổng hợp vote
        let summaryStr = "";
        if (Object.keys(countByDay).length) {
          // Tìm ngày nhiều nhất
          const maxCount = Math.max(...Object.values(countByDay));
          for (const day in countByDay) {
            summaryStr += `${day}: <b${countByDay[day] === maxCount ? ' style="color:#059669;"' : ''}>${countByDay[day]} người</b> &nbsp; `;
          }
        } else {
          summaryStr = "<i>Chưa có ai vote.</i>";
        }
        summary.innerHTML = summaryStr;
      });
    }
    loadVotes();

    // ========== Gửi vote ==========
    function showMessage(text, type = 'info') {
      msgElement.textContent = text;
      msgElement.style.display = 'block';
      if (type === 'success') {
        msgElement.style.background = '#d1fae5';
        msgElement.style.color = '#065f46';
        msgElement.style.borderColor = '#a7f3d0';
      } else if (type === 'error') {
        msgElement.style.background = '#fee2e2';
        msgElement.style.color = '#991b1b';
        msgElement.style.borderColor = '#fecaca';
      } else {
        msgElement.style.background = '#e0f2fe';
        msgElement.style.color = '#0277bd';
        msgElement.style.borderColor = '#b3e5fc';
      }
      setTimeout(() => {
        msgElement.style.display = 'none';
      }, 3000);
    }

    document.getElementById('voteForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const choice = document.getElementById('choice').value;
      if (!name || !choice) return;
      
      showMessage("Đang gửi vote...", 'info');
      
      db.ref(`votes/${week}/${currentPeriod}/${name}`).set({
        name,
        date: new Date().toLocaleDateString('vi-VN'),
        choice,
        week,
        period: currentPeriod,
        timestamp: Date.now()
      }, (error) => {
        if (error) {
          showMessage("Lỗi gửi vote, vui lòng thử lại!", 'error');
        } else {
          showMessage("Vote thành công! Cảm ơn bạn.", 'success');
          document.getElementById('name').value = '';
          document.getElementById('choice').value = '';
        }
      });
    };
  </script>
</body>
</html>